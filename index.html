<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Bull vs Bear – Tap to Win</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@farcade/game-sdk@latest/dist/index.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      padding-top: env(safe-area-inset-top);
      overflow: hidden;
      user-select: none;
    }
    #game-container {
      width: 100vw;
      height: calc(100vh - env(safe-area-inset-top));
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div id="game-container"></div>
  <script>
    // Telegram init
    window.Telegram = window.Telegram || {};
    Telegram.WebApp = Telegram.WebApp || {};
    const tg = Telegram.WebApp;
    tg.initData = tg.initData || location.search.replace('?', '');
    tg.ready = tg.ready || function(){};
    tg.MainButton = tg.MainButton || {
      setText: ()=>{},
      show: ()=>{},
      hide: ()=>{},
      onClick: ()=>{}
    };
    tg.ready();

    class SplashScene extends Phaser.Scene {
      constructor() { super('SplashScene'); }
      preload() {
        this.load.image('splashBg', 'assets/a.png');
        this.load.image('bullSplash', 'assets/bull.png');
      }
      create() {
        this.add.image(180, 320, 'splashBg').setDisplaySize(360, 640);
        let bullSplashImage = this.add.image(180, 420, 'bullSplash').setScale(0.35);
        this.add.text(50, 100, 'Bull vs Bear', { fontSize: '36px', fill: '#fff', stroke: '#000', strokeThickness: 2 });
        this.add.text(70, 150, 'Tap to Win', { fontSize: '36px', fill: '#F7931A', stroke: '#000', strokeThickness: 2 });
        this.tweens.add({ targets: bullSplashImage, y: '+=10', yoyo: true, repeat: -1, ease: 'Sine.inOut', duration: 800 });
        this.input.once('pointerdown', () => this.scene.start('GameScene'));
        window.FarcadeSDK.singlePlayer.actions.ready();
      }
    }

    class GameScene extends Phaser.Scene {
      constructor() { super('GameScene'); }
      preload() {
        this.load.image('bull', 'assets/bull.png');
        this.load.image('bear', 'assets/bear.png');
        this.load.image('background', 'assets/background.png');
        this.load.image('speedEffect', 'assets/speed.png');
        this.load.image('hitEffect', 'assets/hit.png');
      }
      create() {
        this.add.image(180, 320, 'background').setDisplaySize(360, 640);
        this.level = 1;
        this.totalPoints = 0;
        this.levelText = this.add.text(10, 70, 'Level: ' + this.level, { fontSize: '20px', fill: '#FFD700' });
        this.pointsText = this.add.text(10, 100, 'Points: ' + this.totalPoints, { fontSize: '20px', fill: '#fff' });

        this.bear = this.add.sprite(260, 420, 'bear').setScale(0.25);
        this.bull = this.add.sprite(100, 420, 'bull').setScale(0.25);

        this.add.rectangle(180, 40, 210, 20, 0x333333).setStrokeStyle(2, 0x000);
        this.setupBearHealth();
        this.healthBarFill = this.add.rectangle(180, 40, (this.currentHealth/this.maxHealth)*200, 16, 0x0f0);
        this.add.rectangle(180, 600, 210, 20, 0x333333).setStrokeStyle(2, 0x000);
        this.setupBullHealth();
        this.bullBarFill = this.add.rectangle(180, 600, (this.bullHealth/this.bullMaxHealth)*200, 16, 0xf00);

        this.scoreText = this.add.text(180, 80, 'Score: 0', { fontSize: '24px', fill: '#fff' }).setOrigin(0.5);
        this.input.on('pointerdown', this.handleTap, this);

        this.bearAttackEvent = this.time.addEvent({ delay: 3000 - this.level*200, callback: this.bearAttack, callbackScope: this, loop: true });

        window.FarcadeSDK.on('play_again', () => this.restartRound());

        this.tapCount = 0;
        this.lastTapTime = this.time.now;
        this.gameOverCalled = false;

        this.input.once('pointerdown', () => { this.startTime = this.time.now; });

        this.tweens.add({ targets: this.bull, y: '+=10', yoyo: true, repeat: -1, ease: 'Sine.inOut', duration: 800 });
      }
      setupBearHealth() {
        const min = 80 + (this.level-1)*20, max = 120 + (this.level-1)*20;
        this.maxHealth = Phaser.Math.Between(min, max);
        this.currentHealth = this.maxHealth;
      }
      setupBullHealth() {
        this.bullMaxHealth = 100;
        this.bullHealth = this.bullMaxHealth;
      }
      handleTap() {
        if (this.gameOverCalled) return;
        const now = this.time.now, tapsPS = 1000/(now - this.lastTapTime);
        this.lastTapTime = now; this.tapCount++;
        this.scoreText.setText('Score: ' + this.tapCount);

        let reduction = Math.floor(this.tapCount/50);
        let dmg = (tapsPS>500 ? Math.max(3,10-reduction) : Math.max(1,5-reduction)) + (this.level-1);
        if (tapsPS>800) dmg*=2;

        this.currentHealth = Phaser.Math.Clamp(this.currentHealth - dmg, 0, this.maxHealth);
        this.healthBarFill.width = (this.currentHealth/this.maxHealth)*200;

        this.tweens.timeline({ targets:this.bull, tweens:[{x:this.bear.x-20,duration:100},{x:100,duration:100}] });

        const hit = this.add.image(this.bear.x,this.bear.y,'hitEffect').setScale(0.15).setDepth(3);
        this.tweens.add({ targets: hit, alpha:0, duration:200, onComplete:()=>hit.destroy() });

        if (this.currentHealth<=0) this.roundOver();
      }
      bearAttack() {
        if (this.gameOverCalled) return;
        this.tweens.timeline({ targets:this.bear, tweens:[{x:this.bull.x+20,duration:150},{x:260,duration:150}] });
        let bd = Phaser.Math.Between(5,10)+(this.level-1);
        this.bullHealth = Phaser.Math.Clamp(this.bullHealth - bd, 0, this.bullMaxHealth);
        this.bullBarFill.width = (this.bullHealth/this.bullMaxHealth)*200;
        this.tweens.add({ targets:this.bull, tint:0xff0000, duration:200, yoyo:true, onComplete:()=>this.bull.clearTint() });

        if (this.bullHealth<=0) this.roundOver(true);
      }
      roundOver(playerLost=false) {
        this.gameOverCalled = true;
        this.bearAttackEvent.remove();

        [this.bear,this.bull].forEach(s=>this.tweens.add({ targets:s, alpha:0.5, duration:300, yoyo:true, repeat:2 }));

        tg.MainButton.setText('Играть снова');
        tg.MainButton.show();
        tg.MainButton.onClick(() => {
          tg.MainButton.hide();
          this.restartRound();
        });

        this.time.delayedCall(1000, ()=> window.FarcadeSDK.singlePlayer.actions.gameOver({ score: this.tapCount }));
      }
      restartRound() {
        this.totalPoints += this.tapCount;
        this.level++;
        this.pointsText.setText('Points: ' + this.totalPoints);
        this.levelText.setText('Level: ' + this.level);

        this.setupBearHealth();
        this.healthBarFill.width = (this.currentHealth/this.maxHealth)*200;
        this.setupBullHealth();
        this.bullBarFill.width = (this.bullHealth/this.bullMaxHealth)*200;

        this.tapCount = 0;
        this.lastTapTime = this.time.now;
        this.gameOverCalled = false;
        this.scoreText.setText('Score: 0');
        this.bull.x = 100;
        this.bear.clearTint();

        this.bearAttackEvent.reset({ delay: Math.max(1000,3000-this.level*200) });
      }
    }

    new Phaser.Game({
      type: Phaser.AUTO,
      width: 360,
      height: 640,
      parent: 'game-container',
      scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
      scene: [SplashScene, GameScene]
    });
  </script>
</body>
</html>
